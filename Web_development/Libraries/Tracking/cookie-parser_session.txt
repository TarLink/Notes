
                           
   COOKIE-PARSER SESSION   
                           


VERSION ==>                   #Node module 1.3.2

COOKIE-PARSER                 #Express MIDWR parsing REQ.cookies and (if 'SECRET'[_ARR]) REQ.secret|signedCookies
(['SECRET'[_ARR]][, OPTS])    #In short: 
                              #  - REQ.cookies|signedCookies should contain COOKIE_OBJ
                              #  - if RES.send(..., {signed: true}), REQ.signedCookies used instead
                              #     - make sure cookie was set by server sharing 'SECRET' (i.e. current one)
                              #OPTS: passed to COOKIE.parse()

REQ.[signedC|c]ookies         #COOKIE_OBJ, using Cookie [C]
                              #Uses JSONCookies(), i.e. values 'j:JSON' -> OBJ
                              #If 'signed', uses signedCookies(..., 'SECRET'[_ARR]), i.e. values 's:VAL.HASH' -> 'VAL' or (if invalid HASH) delete key
REQ.secret                    #'SECRET' (first one if ARR)
                              #Used by RES.cookie(..., {signed: true}) for Set-Cookie: 's:VAL.HASH' [S]

COOKIE-PARSER.JSONCookie      
('j:JSON')->OBJ|undefined     #Returns JSON.parse('JSON'), or undefined if problem
COOKIE-PARSER.JSONCookies(OBJ)
->OBJ                         #Calls JSONCookie() on each OBJ value
COOKIE-PARSER.signedCookie
('s:VAL.HASH', 'SECRET'[_ARR])#Verifies HASH, using any 'SECRET', with COOKIE-SIGNATURE (see its doc)
->'VAL'|false                 #Returns 'VAL' if success, false otherwise
COOKIE-PARSER.signedCookies
(OBJ, 'SECRET'[_ARR])->OBJ    #Calls signedCookie() on each OBJ value. Only keeps values !== false



VERSION ==>                   #1.14.0


EXPRESS-SESSION([OPTS])       #Express MIDWR that parses REQ.session|sessionID|sessionStore
                              #Goal is to use session-specific state OBJ (REQ.session):
                              #  - retrieved using an authenticated cookie (REQ.sessionId)
                              #  - backed by any database (REQ.sessionStore)

REQ.sessionID                 #Value of cookie:
                              #  - name: OPTS.name (def: 'connect.sid')
                              #  - value: OPTS.genid(REQ)->'VAL'
                              #     - def: 24 bytes using CRYPTO.randomBytes(), as base64
                              #        - i.e. 50% of 1 collision if 8e10 concurrent sessions
                              #  - options:
                              #     - OPTS.cookie OBJ: maxAge, expires, secure, httpOnly, domain, path, sameSite (see COOKIE)
                              #     - httpOnly: def true
                              #     - path: def '/'
                              #     - secure: 
                              #        - should put true
                              #        - 'auto':
                              #           - true|false if HTTPS
                              #           - if OPTS.proxy true, uses X-Forwarded-Proto [C]
                              #           - if OPTS.proxy undefined (def), uses REQ.secure
                              #     - maxAge:
                              #        - def: null, i.e. browser-session only
                              #        - should use it instead of expires
                              #        - STORE.touch() updates it, i.e. restore initial maxAge but updated with current time
                              #           - updated at each request (if OPTS.rolling true) or when REQ.session changed (if OPTS.rolling false (def))
                              #Cookie uses signed cookies (like COOKIE-PARSER):
                              #  - uses OPTS.secret 'SECRET'[_ARR]
                              #     - if HASH verification fails, recreates an new empty REQ.session
                              #  - use COOKIE (see its doc) 
                              #  - does not use COOKIE-PARSER (i.e. not required) but emulates same behavior
                              #     - but do not set REQ.signedCookies|secret
                              #     - if using COOKIE-PARSER, should use same 'SECRET'[_ARR]

REQ.session                   #Any data OBJ for the specific session, usually serialized as JSON
                              #Persisted to store (REQ.session.save()) after each request unless it:
                              #  - did not change (JSON hash comparison) and OPTS.resave false
                              #  - is new, empty and OPTS.saveUnitialized false
                              #  - is set to null
                              #     - if OPTS.unset 'destroy', calls STORE.destroy() too
                              #OPTS.resave|saveUninitialized must always be defined
REQ.session.cookie            #COOKIE_OBJ
REQ.session.save(FUNC(ERROR)) #Calls STORE.set()
REQ.session.touch()           #Updates expiration
REQ.session.reload(FUNC(EROR))#Discard current request changes for REQ.session
REQ.session.regenerate
(FUNC(ERROR))                 #Calls STORE.regenerate()
REQ.session.destroy(FUNC(ERR))#Deletes REQ.session, then calls STORE.destroy()

REQ.sessionStore              #How REQ.session is persisted to database.
                              #Can be customized with OPTS.store OBJ:
                              #  - must inherit from Store
                              #  - must redefine STORE.destroy|get|set()
                              #  - should redefine STORE.touch()
                              #  - can redefine STORE.all|clear|length()
                              #  - should not redefine STORE.createSession|regenerate()
STORE.get(...)                #Get REQ.session
STORE.length(...)             #Gets number of sessions
STORE.all(...)                #Gets all sessions
STORE.set(...)                #Set REQ.session
STORE.touch(...)              #Updates expiration
STORE.createSession(...)      #Restore REQ.session (not for first request)
STORE.destroy(...)            #Deletes REQ.session
STORE.regenerate(...)         #Replaces REQ.session with empty object
STORE.clear(...)              #Deletes all sessions

MEMORYSTORE                   #Def STORE:
                              #  - use memory (internal OBJ2) 
                              #  - should be used in dev only, since no durability


                              #      - new (CONNECT-REDIS(EXPRESS-SESSION))(OBJ): (version 2.0.0)
                              #         - use Redis:
                              #            - setex PREFIXsessionID MAXAGE REQ.session_asJSON
                              #               - MAXAGE can be overriden with OBJ.ttl (in sec) (useless)
                              #               - if no MAXAGE, use one day
                              #               - PREFIX is OBJ.prefix (def: "sess:")
                              #            - get|del PREFIXsessionID
                              #         - OBJ:
                              #            - host HOST, port PORT, db NUM, pass PASSWORD
                              #            - or url REDIS_URL
                              #            - client CLIENT: a REDIS CLIENT
                              #            - any PARAM_OBJ to REDIS

                              #      - new (CONNECT-MONGO(EXPRESS-SESSION))(OBJ): (version 0.7.0)
                              #         - use MongoDB, COLL "sessions" (or OBJ.collection STR):
                              #            - with TTL OBJ.ttl NUM (in sec, def: 14 days)
                              #            - must either create TTL index manually or use OBJ.autoRemove "native" (def)
                              #              (create it at startup)
                              #         - OBJ:
                              #            - mongooseConnection ^DB or db ~DB: to reuse a connection
                              #            - url CONN_STR: if not reusing a connection
                              #            - mongoOptions OBJ
                              #            - stringify BOOL: if true (def: false), use JSON.stringify|parse() for REQ.session
                              #              (if contains types not supported by MongoDB)
                              #            - [un]serialize(OBJ)->OBJ: modify REQ.session from|to MongoDB

COOKIE-SESSION ==>            #Alternative to SESSION that:
                              #  - uses KEYGRIP (rotating secret)
                              #  - doesn't deserialize JSON
                              #Prefer SESSION
